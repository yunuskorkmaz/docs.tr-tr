---
title: 'Nasıl yapılır: İş Parçacığı Yerel Değişkenleriyle bir Parallel.For Döngüsü Yazma'
description: Döngünün her ayrı görevde durum depolayan ve alan iş parçacığı yerel değişkenleri kullanan, .NET 'teki bir Parallel. for döngüsünün nasıl yazılacağını gösteren bir örnek görürsünüz.
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
ms.openlocfilehash: 9cff507757aab2e5676df2fabb02a237a2172c17
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 06/09/2020
ms.locfileid: "84599795"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="27001-103">Nasıl yapılır: İş Parçacığı Yerel Değişkenleriyle bir Parallel.For Döngüsü Yazma</span><span class="sxs-lookup"><span data-stu-id="27001-103">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="27001-104">Bu örnek, bir döngü tarafından oluşturulan her ayrı görevde durumu depolamak ve almak için iş parçacığı yerel değişkenlerinin nasıl kullanılacağını gösterir <xref:System.Threading.Tasks.Parallel.For%2A> .</span><span class="sxs-lookup"><span data-stu-id="27001-104">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="27001-105">İş parçacığı yerel verilerini kullanarak, paylaşılan duruma çok sayıda erişimi eşitleme yükünden kaçınabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="27001-105">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="27001-106">Her yinelemede paylaşılan bir kaynağa yazmak yerine, görev için tüm yinelemeler tamamlanana kadar değeri hesaplar ve depolar.</span><span class="sxs-lookup"><span data-stu-id="27001-106">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="27001-107">Ardından, son sonucu paylaşılan kaynağa yazabilir veya başka bir yönteme geçirebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="27001-107">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="27001-108">Örnek</span><span class="sxs-lookup"><span data-stu-id="27001-108">Example</span></span>  
 <span data-ttu-id="27001-109">Aşağıdaki örnek, <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> 1.000.000 öğelerini içeren bir dizideki değerlerin toplamını hesaplamak için yöntemini çağırır.</span><span class="sxs-lookup"><span data-stu-id="27001-109">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="27001-110">Her öğenin değeri, dizinine eşittir.</span><span class="sxs-lookup"><span data-stu-id="27001-110">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="27001-111">Her yöntemin ilk iki parametresi, <xref:System.Threading.Tasks.Parallel.For%2A> Başlangıç ve bitiş yineleme değerlerini belirtir.</span><span class="sxs-lookup"><span data-stu-id="27001-111">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="27001-112">Yönteminin bu aşırı yüküne üçüncü parametresi, yerel eyaletinizi başlattığınız yerdir.</span><span class="sxs-lookup"><span data-stu-id="27001-112">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="27001-113">Bu bağlamda yerel durum, ömrü son yinelemeden hemen sonra olmak üzere geçerli iş parçacığındaki döngünün ilk yinelemesinden hemen önce olan bir değişken anlamına gelir.</span><span class="sxs-lookup"><span data-stu-id="27001-113">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="27001-114">Üçüncü parametrenin türü, <xref:System.Func%601> `TResult` iş parçacığı yerel durumunu depolayacak değişkenin türüdür.</span><span class="sxs-lookup"><span data-stu-id="27001-114">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="27001-115">Türü, genel yöntem çağrılırken sağlanan genel tür bağımsız değişkeni tarafından tanımlanır <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> , bu durumda <xref:System.Int64> .</span><span class="sxs-lookup"><span data-stu-id="27001-115">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="27001-116">Tür bağımsız değişkeni derleyiciye iş parçacığı yerel durumunu depolamak için kullanılacak geçici değişkenin türünü söyler.</span><span class="sxs-lookup"><span data-stu-id="27001-116">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="27001-117">Bu örnekte, ifadesi `() => 0` (veya `Function() 0` Visual Basic), Thread-Local değişkenini sıfır olarak başlatır.</span><span class="sxs-lookup"><span data-stu-id="27001-117">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="27001-118">Genel tür bağımsız değişkeni bir başvuru türü veya Kullanıcı tanımlı değer türsiyse, ifade şöyle görünür:</span><span class="sxs-lookup"><span data-stu-id="27001-118">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="27001-119">Dördüncü parametre döngü mantığını tanımlar.</span><span class="sxs-lookup"><span data-stu-id="27001-119">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="27001-120">İmzası `Func<int, ParallelLoopState, long, long>` C# veya Visual Basic içinde olan bir temsilci veya lambda ifadesi olmalıdır `Func(Of Integer, ParallelLoopState, Long, Long)` .</span><span class="sxs-lookup"><span data-stu-id="27001-120">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="27001-121">İlk parametre, döngünün o yinelemesi için döngü sayacının değeridir.</span><span class="sxs-lookup"><span data-stu-id="27001-121">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="27001-122">İkincisi, <xref:System.Threading.Tasks.ParallelLoopState> döngüyü bölmek için kullanılabilecek bir nesnedir; bu nesne, <xref:System.Threading.Tasks.Parallel> döngünün her geçtiği her bir sınıf tarafından sağlanır.</span><span class="sxs-lookup"><span data-stu-id="27001-122">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="27001-123">Üçüncü parametre iş parçacığı yerel değişkenidir.</span><span class="sxs-lookup"><span data-stu-id="27001-123">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="27001-124">Son parametre, dönüş türüdür.</span><span class="sxs-lookup"><span data-stu-id="27001-124">The last parameter is the return type.</span></span> <span data-ttu-id="27001-125">Bu durumda, türü <xref:System.Int64> tür bağımsız değişkeninde belirttiğimiz tür olur <xref:System.Threading.Tasks.Parallel.For%2A> .</span><span class="sxs-lookup"><span data-stu-id="27001-125">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="27001-126">Bu değişken olarak adlandırılır `subtotal` ve lambda ifadesi tarafından döndürülür.</span><span class="sxs-lookup"><span data-stu-id="27001-126">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="27001-127">Dönüş değeri, `subtotal` döngünün sonraki tekrarında başlatmak için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="27001-127">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="27001-128">Ayrıca, bu son parametreyi her yinelemeye geçirilen bir değer olarak düşünebilirsiniz ve ardından `localFinally` son yineleme tamamlandığında temsilciye geçirilir.</span><span class="sxs-lookup"><span data-stu-id="27001-128">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="27001-129">Beşinci parametre, belirli bir iş parçacığında tüm yinelemeler tamamlandıktan sonra bir kez çağrılan yöntemi tanımlar.</span><span class="sxs-lookup"><span data-stu-id="27001-129">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="27001-130">Giriş bağımsız değişkeninin türü, metodun tür bağımsız değişkenine <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> ve gövde lambda ifadesi tarafından döndürülen türe karşılık gelir.</span><span class="sxs-lookup"><span data-stu-id="27001-130">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="27001-131">Bu örnekte, değeri yöntemini çağırarak iş parçacığı güvenli bir şekilde sınıf kapsamındaki bir değişkene eklenir <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="27001-131">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="27001-132">İş parçacığı yerel değişkeni kullanarak döngünün her yinelemesinde Bu sınıf değişkenine yazmayı önliyoruz.</span><span class="sxs-lookup"><span data-stu-id="27001-132">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="27001-133">Lambda ifadelerinin nasıl kullanılacağı hakkında daha fazla bilgi için bkz. [PLıNQ ve TPL Içindeki lambda ifadeleri](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="27001-133">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="27001-134">Ayrıca bkz.</span><span class="sxs-lookup"><span data-stu-id="27001-134">See also</span></span>

- [<span data-ttu-id="27001-135">Veri paralelliği</span><span class="sxs-lookup"><span data-stu-id="27001-135">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="27001-136">Paralel programlama</span><span class="sxs-lookup"><span data-stu-id="27001-136">Parallel Programming</span></span>](index.md)
- [<span data-ttu-id="27001-137">Görev Paralel Kitaplığı (TPL)</span><span class="sxs-lookup"><span data-stu-id="27001-137">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
- [<span data-ttu-id="27001-138">PLıNQ ve TPL 'deki lambda Ifadeleri</span><span class="sxs-lookup"><span data-stu-id="27001-138">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
