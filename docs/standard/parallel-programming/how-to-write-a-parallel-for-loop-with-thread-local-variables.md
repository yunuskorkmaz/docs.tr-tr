---
title: 'Nasıl yapılır: İş Parçacığı Yerel Değişkenleriyle bir Parallel.For Döngüsü Yazma'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: a70b8e3d1f56eafc04b97a19a1582d9c664e587d
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 05/04/2018
ms.locfileid: "33584676"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="d593b-102">Nasıl yapılır: İş Parçacığı Yerel Değişkenleriyle bir Parallel.For Döngüsü Yazma</span><span class="sxs-lookup"><span data-stu-id="d593b-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="d593b-103">Bu örnek tarafından oluşturulan her ayrı görev durumda depolanıp iş parçacığı yerel değişkenleri kullanmayı gösterir bir <xref:System.Threading.Tasks.Parallel.For%2A> döngü.</span><span class="sxs-lookup"><span data-stu-id="d593b-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="d593b-104">İş parçacığı yerel verileri kullanarak, çok sayıda paylaşılan durum erişimin eşitleme yükünü önleyebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="d593b-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="d593b-105">Paylaşılan kaynağa her yinelemesinde yazmak, yerine işlem ve görev için tüm yinelemeleri tamamlanana kadar değeri saklayın.</span><span class="sxs-lookup"><span data-stu-id="d593b-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="d593b-106">Sonra nihai sonucu kez paylaşılan kaynağa yazma veya başka bir yönteme geçirin.</span><span class="sxs-lookup"><span data-stu-id="d593b-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="d593b-107">Örnek</span><span class="sxs-lookup"><span data-stu-id="d593b-107">Example</span></span>  
 <span data-ttu-id="d593b-108">Aşağıdaki örnek çağrıları <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> bir milyon öğeleri içeren bir dizi değerlerin toplamını hesaplamak için yöntem.</span><span class="sxs-lookup"><span data-stu-id="d593b-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="d593b-109">Her öğenin değerini kendi dizinine eşittir.</span><span class="sxs-lookup"><span data-stu-id="d593b-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="d593b-110">İlk iki parametrelerinin her <xref:System.Threading.Tasks.Parallel.For%2A> yöntemi, başlangıç ve bitiş yineleme değerlerini belirtin.</span><span class="sxs-lookup"><span data-stu-id="d593b-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="d593b-111">Bu yöntem aşırı içinde yerel durumunuza başlatma burada üçüncü parametresidir.</span><span class="sxs-lookup"><span data-stu-id="d593b-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="d593b-112">Bu bağlamda yerel durumu son yinelemeden sonra yalnızca için geçerli iş parçacığı üzerinde ilk döngü hemen önce gelen, yaşam süresi genişleten bir değişken anlamına gelir.</span><span class="sxs-lookup"><span data-stu-id="d593b-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="d593b-113">Üçüncü parametre türü bir <xref:System.Func%601> burada `TResult` yerel iş parçacığı durumu depolayacak değişkeni türüdür.</span><span class="sxs-lookup"><span data-stu-id="d593b-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="d593b-114">Türünü genel çağrılırken genel tür bağımsız değişkeni tarafından tanımlanan <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> bu durumda yöntemi <xref:System.Int64>.</span><span class="sxs-lookup"><span data-stu-id="d593b-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="d593b-115">Tür bağımsız değişkeni derleyici iş parçacığı yerel durumunu depolamak için kullanılan geçici değişken türünü bildirir.</span><span class="sxs-lookup"><span data-stu-id="d593b-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="d593b-116">Bu örnekte, ifade `() => 0` (veya `Function() 0` Visual Basic'te) iş parçacığı yerel değişkeni sıfırdan başlatır.</span><span class="sxs-lookup"><span data-stu-id="d593b-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="d593b-117">Genel tür bağımsız değişkeni bir başvuru veya kullanıcı tanımlı bir değer türü ise, ifade şöyle olabilir:</span><span class="sxs-lookup"><span data-stu-id="d593b-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="d593b-118">Dördüncü parametrenin döngü mantığı tanımlar.</span><span class="sxs-lookup"><span data-stu-id="d593b-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="d593b-119">İmza bir temsilci ya da lambda ifadesi olmalıdır `Func<int, ParallelLoopState, long, long>` C# veya `Func(Of Integer, ParallelLoopState, Long, Long)` Visual Basic'te.</span><span class="sxs-lookup"><span data-stu-id="d593b-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="d593b-120">İlk parametre Bu döngü döngü sayaç değeri.</span><span class="sxs-lookup"><span data-stu-id="d593b-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="d593b-121">İkinci bir <xref:System.Threading.Tasks.ParallelLoopState> ; bu nesne tarafından sağlanan dışında döngüsünü kesmek için kullanılabilir nesne <xref:System.Threading.Tasks.Parallel> döngünün her oluşumu sınıfı.</span><span class="sxs-lookup"><span data-stu-id="d593b-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="d593b-122">Üçüncü parametre iş parçacığı yerel değişkenidir.</span><span class="sxs-lookup"><span data-stu-id="d593b-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="d593b-123">Dönüş türü son parametresidir.</span><span class="sxs-lookup"><span data-stu-id="d593b-123">The last parameter is the return type.</span></span> <span data-ttu-id="d593b-124">Bu durumda, türüdür <xref:System.Int64> türü olduğu için biz belirtilen <xref:System.Threading.Tasks.Parallel.For%2A> bağımsız değişkeni yazın.</span><span class="sxs-lookup"><span data-stu-id="d593b-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="d593b-125">Bu değişken adlı `subtotal` ve lambda ifadesi tarafından döndürülen.</span><span class="sxs-lookup"><span data-stu-id="d593b-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="d593b-126">Dönüş değeri başlatmak için kullanılan `subtotal` sonraki her döngü tekrarında üzerinde.</span><span class="sxs-lookup"><span data-stu-id="d593b-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="d593b-127">Bu son parametresi, her bir yineleme için geçirilen ve için geçirilen değer olarak düşünebilirsiniz `localFinally` son yineleme tamamlandığında temsilci.</span><span class="sxs-lookup"><span data-stu-id="d593b-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="d593b-128">Beşinci parametrenin belirli bir iş parçacığı üzerinde tüm yinelemeleri tamamladıktan sonra bir kez çağrılır yöntemi tanımlar.</span><span class="sxs-lookup"><span data-stu-id="d593b-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="d593b-129">Giriş bağımsız değişkeni tür tür bağımsız değişkeni yeniden karşılık gelen <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> yöntemi ve gövde lambda ifadesi tarafından döndürülen tür.</span><span class="sxs-lookup"><span data-stu-id="d593b-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="d593b-130">Bu örnekte, değeri bir değişkene sınıfı kapsamdaki iş parçacığı güvenli bir yolla çağrılarak eklenir <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> yöntemi.</span><span class="sxs-lookup"><span data-stu-id="d593b-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d593b-131">Bir iş parçacığı yerel değişkeni kullanarak, biz Bu sınıf değişkeni her döngü tekrarında üzerine yazılmasını kaçınılması.</span><span class="sxs-lookup"><span data-stu-id="d593b-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="d593b-132">Lambda ifadeleri kullanma hakkında daha fazla bilgi için bkz: [PLINQ ve TPL'deki Lambda ifadeleri](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="d593b-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d593b-133">Ayrıca Bkz.</span><span class="sxs-lookup"><span data-stu-id="d593b-133">See Also</span></span>  
 [<span data-ttu-id="d593b-134">Veri Paralelliği</span><span class="sxs-lookup"><span data-stu-id="d593b-134">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="d593b-135">Paralel Programlama</span><span class="sxs-lookup"><span data-stu-id="d593b-135">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)  
 [<span data-ttu-id="d593b-136">Görev Paralel Kitaplığı (TPL)</span><span class="sxs-lookup"><span data-stu-id="d593b-136">Task Parallel Library (TPL)</span></span>](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)  
 [<span data-ttu-id="d593b-137">PLINQ ve TPL'deki Lambda İfadeleri</span><span class="sxs-lookup"><span data-stu-id="d593b-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
