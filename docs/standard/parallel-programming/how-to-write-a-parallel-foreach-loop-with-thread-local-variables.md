---
title: "Nasıl yapılır: İş Parçacığı Yerel Değişkenleriyle bir Parallel.ForEach Döngüsü Yazma"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
caps.latest.revision: 
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.workload:
- dotnet
- dotnetcore
ms.openlocfilehash: 4c65edd8959cbf5f83e3353770f71cad130953d1
ms.sourcegitcommit: e7f04439d78909229506b56935a1105a4149ff3d
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 12/23/2017
---
# <a name="how-to-write-a-parallelforeach-loop-with-thread-local-variables"></a><span data-ttu-id="2cb3a-102">Nasıl yapılır: İş Parçacığı Yerel Değişkenleriyle bir Parallel.ForEach Döngüsü Yazma</span><span class="sxs-lookup"><span data-stu-id="2cb3a-102">How to: Write a Parallel.ForEach Loop with Thread-Local Variables</span></span>
<span data-ttu-id="2cb3a-103">Aşağıdaki örnekte nasıl yazılacağını gösterir bir <xref:System.Threading.Tasks.Parallel.ForEach%2A> iş parçacığı yerel değişkenleri kullanan yöntemi.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables.</span></span> <span data-ttu-id="2cb3a-104">Zaman bir <xref:System.Threading.Tasks.Parallel.ForEach%2A> döngü yürütür, kendi kaynak koleksiyonu birden çok bölümlere ayırır.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="2cb3a-105">Her bölüm "iş parçacığı-yerel" değişkeni kopyasını alır.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-105">Each partition will get its own copy of the "thread-local" variable.</span></span> <span data-ttu-id="2cb3a-106">(Bazı durumlarda iki bölüm aynı iş parçacığı üzerinde çalışabilir "iş parçacığı-yerel" terimi burada biraz yanlış çünkü.)</span><span class="sxs-lookup"><span data-stu-id="2cb3a-106">(The term "thread-local" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)</span></span>  
  
 <span data-ttu-id="2cb3a-107">Bu örnekte parametreleri ve kod yakından ilgili benzer <xref:System.Threading.Tasks.Parallel.For%2A> yöntemi.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="2cb3a-108">Daha fazla bilgi için bkz: [nasıl yapılır: iş parçacığı yerel değişkenleriyle bir Parallel.For döngüsü yazma](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span><span class="sxs-lookup"><span data-stu-id="2cb3a-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>  
  
 <span data-ttu-id="2cb3a-109">Bir iş parçacığı yerel değişkende kullanmak için bir <xref:System.Threading.Tasks.Parallel.ForEach%2A> döngüsü çağırmanız gerekir iki tür parametreleri alır yöntemi aşırı yüklemelerinden birini.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-109">To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="2cb3a-110">İlk tür parametresi `TSource`, kaynak öğesi ve ikinci tür parametre türünü belirtir `TLocal`, iş parçacığı yerel değişken türünü belirtir.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.</span></span>  
  
## <a name="example"></a><span data-ttu-id="2cb3a-111">Örnek</span><span class="sxs-lookup"><span data-stu-id="2cb3a-111">Example</span></span>  
 <span data-ttu-id="2cb3a-112">Aşağıdaki örnek çağrıları <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> bir dizi bir milyon öğelerin toplamını hesaplamak için aşırı yükleme.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-112">The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="2cb3a-113">Bu aşırı dört parametre vardır:</span><span class="sxs-lookup"><span data-stu-id="2cb3a-113">This overload has four parameters:</span></span>  
  
-   <span data-ttu-id="2cb3a-114">`source`, veri kaynağı değil.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-114">`source`, which is the data source.</span></span> <span data-ttu-id="2cb3a-115">Uygulamanız gerekir <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="2cb3a-116">Bizim örneğimizde veri kaynağında bir milyon üyesidir `IEnumerable<Int32>` tarafından döndürülen nesne <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> yöntemi.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>  
  
-   <span data-ttu-id="2cb3a-117">`localInit`, veya iş parçacığı yerel değişkenini işlevi.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-117">`localInit`, or the function that initializes the thread-local variable.</span></span> <span data-ttu-id="2cb3a-118">Bu işlev, her bölüm için bir kez çağrılır <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> işlemini yürütür.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="2cb3a-119">Bizim örneğimizde iş parçacığı yerel değişkeni sıfır başlatır.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-119">Our example initializes the thread-local variable to zero.</span></span>  
  
-   <span data-ttu-id="2cb3a-120">`body`, bir <xref:System.Func%604> her döngü tekrarında üzerinde paralel döngü tarafından çağrılır.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="2cb3a-121">Kendi imzası `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="2cb3a-122">Kod için temsilci sağlayın ve döngü olan giriş parametrelerinde geçirir:</span><span class="sxs-lookup"><span data-stu-id="2cb3a-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>  
  
    -   <span data-ttu-id="2cb3a-123">Geçerli öğenin <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>  
  
    -   <span data-ttu-id="2cb3a-124">A <xref:System.Threading.Tasks.ParallelLoopState> değişken döngü durumunu incelemek için temsilcinin kodda kullanabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>  
  
    -   <span data-ttu-id="2cb3a-125">İş parçacığı yerel değişkeni.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-125">The thread-local variable.</span></span>  
  
     <span data-ttu-id="2cb3a-126">Temsilciniz sonraki döngü belirli bu bölümünde yürüten geçirilir iş parçacığı yerel değişkeni döndürür.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-126">Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="2cb3a-127">Her döngü bölüm bu değişken ayrı bir örneğini saklar.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-127">Each loop partition maintains a separate instance of this variable.</span></span>  
  
     <span data-ttu-id="2cb3a-128">Örnekte, her tamsayı değerini temsilci, çalışan bir tutar iş parçacığı yerel değişkene ekler. Bu bölümde tamsayı öğelerinin değerlerini toplam.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-128">In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>  
  
-   <span data-ttu-id="2cb3a-129">`localFinally`, bir `Action<TLocal>` , temsilci <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> her bölüm döngü işlemlerinde tamamlandığında çağırır.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="2cb3a-130"><xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> Yöntemi geçişleri, `Action<TLocal>` temsilci iş parçacığı yerel değişken bu iş parçacığı (veya döngü bölüm) için son değeri ve bu bölümü sonucundan sonuçlarla birleştirme için gerekli bir eylem gerçekleştirir kodu sağlayın diğer bölümler.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="2cb3a-131">Bu temsilci eşzamanlı olarak birden çok görev tarafından çağrılabilir.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="2cb3a-132">Bu nedenle, örnek kullanır <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> erişimi eşitlemek için yöntemi `total` değişkeni.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="2cb3a-133">Temsilci türü olduğundan bir <xref:System.Action%601>, dönüş değeri yoktur.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>  
  
 [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
 [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  
  
## <a name="see-also"></a><span data-ttu-id="2cb3a-134">Ayrıca Bkz.</span><span class="sxs-lookup"><span data-stu-id="2cb3a-134">See Also</span></span>  
 [<span data-ttu-id="2cb3a-135">Veri Paralelliği</span><span class="sxs-lookup"><span data-stu-id="2cb3a-135">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="2cb3a-136">Nasıl yapılır: İş Parçacığı Yerel Değişkenleriyle bir Parallel.For Döngüsü Yazma</span><span class="sxs-lookup"><span data-stu-id="2cb3a-136">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)  
 [<span data-ttu-id="2cb3a-137">PLINQ ve TPL'deki Lambda İfadeleri</span><span class="sxs-lookup"><span data-stu-id="2cb3a-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
