---
title: SQL Server'da güvenli dinamik SQL yazma
ms.date: 03/30/2017
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
ms.openlocfilehash: cbfbfd59d78cb5504679fd8ae78f79d0c180dc4d
ms.sourcegitcommit: d8bf4976eafe3289275be3811e7cb721bfff7e1e
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 06/04/2018
ms.locfileid: "34753480"
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="52328-102">SQL Server'da güvenli dinamik SQL yazma</span><span class="sxs-lookup"><span data-stu-id="52328-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="52328-103">SQL ekleme olarak Transact-SQL deyimi geçerli giriş yerine kötü niyetli bir kullanıcının girdiği işlemidir.</span><span class="sxs-lookup"><span data-stu-id="52328-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="52328-104">Giriş doğrulamasından geçmeden doğrudan sunucuya geçirilir ve uygulama yanlışlıkla eklenen kod yürütülürse, saldırı zarar veya verilere zarar olasılığı vardır.</span><span class="sxs-lookup"><span data-stu-id="52328-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="52328-105">SQL Server aldığı tüm sözdizimsel olarak geçerli sorguları yürütecek olduğundan SQL deyimlerini oluşturur herhangi bir yordam ekleme güvenlik açıkları için gözden geçirilmesi gerekir.</span><span class="sxs-lookup"><span data-stu-id="52328-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="52328-106">Hatta parametreli veri becerikli ve belirlenen bir saldırgan tarafından yönetilebilir.</span><span class="sxs-lookup"><span data-stu-id="52328-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="52328-107">Dinamik SQL kullanırsanız, komutlarınızı Parametreleştirme emin olun ve hiçbir zaman doğrudan sorgu dizesine parametre değerlerini içerir.</span><span class="sxs-lookup"><span data-stu-id="52328-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="52328-108">Bir SQL ekleme saldırısı anatomisi</span><span class="sxs-lookup"><span data-stu-id="52328-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="52328-109">Ekleme işlemi erken bir metin dizesi sonlandırma ve yeni bir komut ekleyerek çalışır.</span><span class="sxs-lookup"><span data-stu-id="52328-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="52328-110">Eklenen komut çalıştırılmadan önce eklenmiş ek dizeleri sahip olabileceği için bir açıklama işareti eklenen dizesiyle malefactor sonlandırır "--".</span><span class="sxs-lookup"><span data-stu-id="52328-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="52328-111">Sonraki metin yürütme sırasında göz ardı edilir.</span><span class="sxs-lookup"><span data-stu-id="52328-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="52328-112">Birden çok komut noktalı virgül (;) kullanılarak eklenebilir sınırlayıcısı.</span><span class="sxs-lookup"><span data-stu-id="52328-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="52328-113">Eklenen SQL kodu sözdizimsel olarak doğru olduğu sürece, izinsiz program aracılığıyla algılanamıyor.</span><span class="sxs-lookup"><span data-stu-id="52328-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="52328-114">Bu nedenle, tüm kullanıcı girişi ve dikkatle kullanmakta olduğunuz sunucuda oluşturulan SQL komutlarını yürüten gözden geçirme kodu doğrulamanız gerekir.</span><span class="sxs-lookup"><span data-stu-id="52328-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="52328-115">Hiçbir zaman doğrulanmazsa kullanıcı girişi art arda ekler.</span><span class="sxs-lookup"><span data-stu-id="52328-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="52328-116">Dize birleştirme komut dosyası ekleme işlemi için giriş birincil noktasıdır.</span><span class="sxs-lookup"><span data-stu-id="52328-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="52328-117">Bazı yardımcı yönergeler şunlardır:</span><span class="sxs-lookup"><span data-stu-id="52328-117">Here are some helpful guidelines:</span></span>  
  
-   <span data-ttu-id="52328-118">Hiçbir kullanıcı girişi doğrudan Transact-SQL deyimi oluşturmak; kullanıcı girişi doğrulamak için saklı yordamları kullanın.</span><span class="sxs-lookup"><span data-stu-id="52328-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
-   <span data-ttu-id="52328-119">Kullanıcı girişi türünü, uzunluğunu, biçimini ve aralığı test ederek doğrulayın.</span><span class="sxs-lookup"><span data-stu-id="52328-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="52328-120">Sistem adlarını veya bir dizede herhangi bir karakter kaçınmak için REPLACE() işlevi kaçınmak için Transact-SQL QUOTENAME() işlevini kullanın.</span><span class="sxs-lookup"><span data-stu-id="52328-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
-   <span data-ttu-id="52328-121">Birden çok katman doğrulama, uygulamanızın her katmanında uygulayın.</span><span class="sxs-lookup"><span data-stu-id="52328-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
-   <span data-ttu-id="52328-122">Giriş boyutu ve veri türünü test edin ve uygun sınırlar zorlayın.</span><span class="sxs-lookup"><span data-stu-id="52328-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="52328-123">Bu, bilinçli arabellek taşmaları önlemeye yardımcı olabilir.</span><span class="sxs-lookup"><span data-stu-id="52328-123">This can help prevent deliberate buffer overruns.</span></span>  
  
-   <span data-ttu-id="52328-124">Dize değişkenlerinin içeriğini test ve beklenen değerleri kabul edin.</span><span class="sxs-lookup"><span data-stu-id="52328-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="52328-125">İkili veriler, çıkış sıraları ve yorum karakterler içeren girdileri reddeder.</span><span class="sxs-lookup"><span data-stu-id="52328-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
-   <span data-ttu-id="52328-126">XML belgeleri ile çalışırken, girilirken şemasına göre tüm verileri doğrulayın.</span><span class="sxs-lookup"><span data-stu-id="52328-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
-   <span data-ttu-id="52328-127">Çok katmanlı ortamlarda, tüm verilerin güvenli bölgeye giriş önce doğrulanması gerekir.</span><span class="sxs-lookup"><span data-stu-id="52328-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
-   <span data-ttu-id="52328-128">Aşağıdaki alanları, dosya adları oluşturulmuş dizelerde kabul ediyor musunuz: AUX, $, LPT8, NUL ve PRN LPT1 CLOCK$, COM1 COM8, CON, yapılandırma ile.</span><span class="sxs-lookup"><span data-stu-id="52328-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
-   <span data-ttu-id="52328-129">Kullanım <xref:System.Data.SqlClient.SqlParameter> saklı yordamları ve türü denetleme ve uzunluğu doğrulama sağlamak için komutları nesneleriyle.</span><span class="sxs-lookup"><span data-stu-id="52328-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
-   <span data-ttu-id="52328-130">Kullanım <xref:System.Text.RegularExpressions.Regex> istemci kodu geçersiz karakterler filtre ifadelerinde.</span><span class="sxs-lookup"><span data-stu-id="52328-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="52328-131">Dinamik SQL stratejileri</span><span class="sxs-lookup"><span data-stu-id="52328-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="52328-132">Dinamik olarak yürütülen SQL deyimlerini, yordam kodu sonlarını SQL Server'ın çağıran dinamik SQL tarafından erişilen nesneler karşı izinlerini denetlemek neden olma zinciri oluşturulur.</span><span class="sxs-lookup"><span data-stu-id="52328-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="52328-133">SQL Server kullanıcıları saklı yordamları ve dinamik SQL Yürüt kullanıcı tanımlı işlevler kullanarak verilere erişim izni verme için yöntemlerine sahiptir.</span><span class="sxs-lookup"><span data-stu-id="52328-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
-   <span data-ttu-id="52328-134">Transact-SQL EXECUTE AS ile kimliğe bürünme kullanılarak açıklandığı gibi yan tümcesi, [kimliğe bürünme SQL Server'daki özelleştirme izinlerle](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="52328-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
-   <span data-ttu-id="52328-135">Sertifikalar, saklı yordamlarda açıklandığı gibi imzalama [imzalama saklı yordamlar SQL Server'daki](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="52328-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="52328-136">EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="52328-136">EXECUTE AS</span></span>  
 <span data-ttu-id="52328-137">EXECUTE izinlerle arayanın, kullanıcının belirtilen EXECUTE AS yan tümcesi değiştirir olarak yan tümcesi.</span><span class="sxs-lookup"><span data-stu-id="52328-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="52328-138">İç içe geçmiş saklı yordamları ve Tetikleyicileri proxy kullanıcı güvenlik bağlamı altında yürütün.</span><span class="sxs-lookup"><span data-stu-id="52328-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="52328-139">Bu satır düzeyi güvenlik kullanır veya denetim gerektiren uygulamaların çalışmamasına neden.</span><span class="sxs-lookup"><span data-stu-id="52328-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="52328-140">EXECUTE AS belirtilen kullanıcının kullanıcı kimliği döndürür bazı işlevler döndürür yan tümcesi, özgün çağıran.</span><span class="sxs-lookup"><span data-stu-id="52328-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="52328-141">Yürütme bağlamı özgün çağırana yalnızca yürütme yordamın veya REVERT deyimi verildiğinde sonra geri döndürüldü.</span><span class="sxs-lookup"><span data-stu-id="52328-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="52328-142">Sertifika İmzalama</span><span class="sxs-lookup"><span data-stu-id="52328-142">Certificate Signing</span></span>  
 <span data-ttu-id="52328-143">Bir sertifika ile imzalanmış bir saklı yordam yürütüldüğünde, sertifika kullanıcıya verilen izinler bu çağrıyı ile birleştirilir.</span><span class="sxs-lookup"><span data-stu-id="52328-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="52328-144">Yürütme bağlamı aynı kalır; Sertifikayı arayan kullanıcını değil.</span><span class="sxs-lookup"><span data-stu-id="52328-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="52328-145">Saklı yordamlar imzalama uygulamak için birkaç adımı gerektirir.</span><span class="sxs-lookup"><span data-stu-id="52328-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="52328-146">Yordam değiştirildiğinde, her zaman yeniden imzalanmış olmalıdır.</span><span class="sxs-lookup"><span data-stu-id="52328-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="52328-147">Veritabanı erişimi arası</span><span class="sxs-lookup"><span data-stu-id="52328-147">Cross Database Access</span></span>  
 <span data-ttu-id="52328-148">Veritabanları arası sahiplik zincirleme dinamik olarak oluşturulan SQL deyimlerini yürütüldüğü durumlarda çalışmaz.</span><span class="sxs-lookup"><span data-stu-id="52328-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="52328-149">Başka bir veritabanındaki verilere erişen bir saklı yordam oluşturarak ve her iki veritabanlarınızda var olan bir sertifika ile yordamı imzalama SQL Server'da bu sorunu çalışabilir.</span><span class="sxs-lookup"><span data-stu-id="52328-149">You can work around this in SQL Server by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="52328-150">Bu kullanıcılar veritabanı erişimi ya da izin vermeden yordamı tarafından kullanılan veritabanı kaynaklarına erişmenizi sağlar.</span><span class="sxs-lookup"><span data-stu-id="52328-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="52328-151">Dış Kaynaklar</span><span class="sxs-lookup"><span data-stu-id="52328-151">External Resources</span></span>  
 <span data-ttu-id="52328-152">Daha fazla bilgi için aşağıdaki kaynaklara bakın.</span><span class="sxs-lookup"><span data-stu-id="52328-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="52328-153">Kaynak</span><span class="sxs-lookup"><span data-stu-id="52328-153">Resource</span></span>|<span data-ttu-id="52328-154">Açıklama</span><span class="sxs-lookup"><span data-stu-id="52328-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="52328-155">[Saklı yordamlar](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) ve [SQL ekleme](/sql/relational-databases/security/sql-injection) SQL Server Çevrimiçi Kitapları'nda</span><span class="sxs-lookup"><span data-stu-id="52328-155">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](/sql/relational-databases/security/sql-injection) in SQL Server Books Online</span></span>|<span data-ttu-id="52328-156">Konularda saklı yordamlar oluşturma ve SQL ekleme nasıl çalıştığı açıklanmaktadır.</span><span class="sxs-lookup"><span data-stu-id="52328-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="52328-157">Ayrıca Bkz.</span><span class="sxs-lookup"><span data-stu-id="52328-157">See Also</span></span>  
 [<span data-ttu-id="52328-158">ADO.NET Uygulamalarının Güvenliğini Sağlama</span><span class="sxs-lookup"><span data-stu-id="52328-158">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)  
 [<span data-ttu-id="52328-159">SQL Server Güvenliğine Genel Bakış</span><span class="sxs-lookup"><span data-stu-id="52328-159">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)  
 [<span data-ttu-id="52328-160">SQL Server'da Uygulama Güvenliği Senaryoları</span><span class="sxs-lookup"><span data-stu-id="52328-160">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)  
 [<span data-ttu-id="52328-161">SQL Server'da Saklı Yordam İzinlerini Yönetme</span><span class="sxs-lookup"><span data-stu-id="52328-161">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="52328-162">SQL Server'da Saklı Yordam İmzalama</span><span class="sxs-lookup"><span data-stu-id="52328-162">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="52328-163">SQL Server'da Kimliğe Bürünme İzinlerini Özelleştirme</span><span class="sxs-lookup"><span data-stu-id="52328-163">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)  
 [<span data-ttu-id="52328-164">ADO.NET yönetilen sağlayıcıları ve veri kümesi Geliştirici Merkezi</span><span class="sxs-lookup"><span data-stu-id="52328-164">ADO.NET Managed Providers and DataSet Developer Center</span></span>](http://go.microsoft.com/fwlink/?LinkId=217917)
